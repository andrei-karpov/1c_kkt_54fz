# Для программистов #

[в начало](README.md#навигация)

В данном разделе будут размещены примеры изменения программы или доработки конфигураций.

## Доработка конфигурации ##

Если ваша конфигурация поддерживает способ подключение "ККТ", то доработка вам не нужна. Для других конфигураций, чтобы явно задать из какого документа происходит печать, и ускорить тем самым данную процедуру, нужно подключить внешнюю печатную форму ["ВПФ_Чек"](instruction.md#структура-архива-с-обработкой), которая лежит в архиве с обработкой, либо сделать небольшую доработку.

Пример изменения конфигурации: [Доработка конфигурации](https://www.youtube.com/watch?v=Ehp2DU-YnqM&index=1&list=PLv043XNq9i-6_DdLAy1kTuExX2E-ikn65)

**Описание действий:**

1. Открываете вашу конфигурацию, в меню "Конфигурация "- "Поддержка" - "Настройка поддержки" проверяете включена ли возможность редактирования конфигурации, если нет, то включаете ее.

2. Ищете все упоминания строки ```ПолучитьСерверТО().ОплатитьПлатежнойКартой```. В тех документах, в которых будет найдена данная строка, перед ней добавить такой код:

    ```bsl
    СохранитьЗначение("ДокументПечатиККТ", Ссылка);
    ```

3. Ищете все упоминания строки ```ПолучитьСерверТО().ПечатьЧека```. В тех документах, в которых будет найдена данная строка, перед ней добавить такой код:

    ```bsl
    СохранитьЗначение("ДокументПечатиККТ", Ссылка);
    ```

4. Для конфигурации Розница 1, возможно нужно еще поискать ```ПолучитьСерверТО().ОткрытьЧек;```. В тех документах, в которых будет найдена данная строка, перед ней добавить такой код:

    ```bsl
    СохранитьЗначение("ДокументПечатиККТ", Ссылка);
    ```

5. Объединяете с основной конфигурацией, нажав кнопку F7.

## Дополнительные параметры ##

![Дополнительные параметры](media/f59e12e9afcf868c7f4bb320fc094d87.png)

Данный механизм можно использовать для разработки собственного обработчика, в данном поле указывается произвольный параметр, а в собственном коде его можно вызвать вот так.

```bsl
ЗначениеПараметра = ОсновнаяОбработка.ККТ_ЗначениеДополнительногоПараметра("ИмяПараметра");
```

## Изменение функционала "под себя" ##

Функционал программы также можно изменить через подключаемую обработку, находящуюся архиве с основной. Обработка называется [KKT_DEVELOPE82](instruction.md#структура-архива-с-обработкой) для 1С версии 8.2 и 8.3 и [KKT_DEVELOPE81](instruction.md#структура-архива-с-обработкой) для версии 8.1 соответственно.

Пример таких изменения описан в [видео](https://youtu.be/5t4pye9cRd8) (_немного устарело_)

### Доступные команды KKT_DEVELOPE ###

Внутри доп обработчика используется определенный набор экспортных команд и переменных, которые при печати будет вызывать основная обработка, и таким образом можно перехватывать и менять заполнение фискального чека.

В области переменных находится одна экспортная переменная:

```Перем ОсновнаяОбработка``` - в ней хранится объект основной обработки, и таким образом можно вызывать команды и переменные доступные только в основной обработке. Пример, ```ОсновнаяОбработка.мПараметрыУстройства``` - вернет структуру параметров обработки.

Помимо этого в любом месте доп обработчика можно вызвать переменные отвечающие за параметры чека и поменять их.
```ОсновнаяОбработка.мОбщиеПараметры``` - содержит данные основного чека, со всеми заполненными полями для печати, сама структура заполняется после вызова ```ОбработатьЧекПоСвоему``` и перед ```ПослеФормированииТаблицыЧека```. Из чего состоит ```мОбщиеПараметры``` можно посмотреть, если открыть основную обработку в конфигураторе, нам понадобится форма "МодульОбщий" там расположен код инициализации ```ПараметрыОперацииФискализацииЧека()```
    ![Модуль общий](media/модульобщий.png)

Помимо параметров из основной обработки можно вызывать и специальные ***формы-модули***, через которое можно выполнять экспортный функции и процедуры, например ранее рассмотренная форма в основной обработке будет вызвана командой ```ОсновнаяОбработка.мМодульККТОбщий.ПараметрыОперацииФискализацииЧека()```, в общей сложности доступны следующие модули:

- ```мМодульККТОбщий``` - форма "МодульОбщий"
- ```мМодульККТШаблон``` - форма "МодульШаблон"
- ```мМодульККТМаркировка``` - форма "МодульМаркировка"
- ```мМодульККТПочтаSMS``` - форма "МодульОтправкаПочтыSMS"
- ```мМодульККТЗапросы``` - форма "МодульРаботаСЗапросами"
- ```мМодульККТСобственная``` - форма "МодульСобственныйОбработчик"
  
#### Экспортные процедуры ОсновнаяОбработка ####

Доступны следующие экспортные процедуры:

```Процедура ПредварительныйПросмотрЧека(СсылкаНаДокумент)``` - формирует и выводит на экран предварительный чек по переданной ссылки документа. Пример,

```bsl
ОсновнаяОбработка.ПредварительныйПросмотрЧека(СсылкаНаДокумент);
```

```Функция ПолучитьКассираСДолжностью(СсылкаНаДокумент = Неопределено)``` - возвращает строку со сформированной должностью и именем кассира. Данные формируются на основании параметров обработки и переданной ссылке на документ (документ указывать необязательно). Пример,

```bsl
КассирСДолжностью = ОсновнаяОбработка.ПолучитьКассираСДолжностью();
```

```Функция ККТ_XMLПредставлениеЧека(ДанныеТекущегоЧека, ПараметрыПодключения, ШиринаСтроки = 32)``` - возвращает XML строку, с данными фискального чека, что будут переданы на оборудование при фискализации, xml будет соответствовать [требованиям к передаче данных](https://its.1c.ru/db/metod8dev/content/4829/hdoc). Чек строится по Структуре переданного чека и его параметрам подключения, ширину строку можно не передавать, таким образом ```ДанныеТекущегоЧека```, по умолчанию равны ```ОсновнаяОбработка.мОбщиеПараметры```, а ```ПараметрыПодключения = ОсновнаяОбработка.мПараметрыПодключения```
Пример,

```bsl
XMLЧек = ОсновнаяОбработка.ККТ_XMLПредставлениеЧека(ОсновнаяОбработка.мОбщиеПараметры, ОсновнаяОбработка.мПараметрыПодключения);
```

```Функция ОбработатьУниверсальныйДок(СсылкаНаДокумент, СписокЧеков, ПараметрыОбработки, СуммаБезНал, СуммаНал, ДополнительнаяСтруктураДокумента = Неопределено)``` -
```СсылкаНаДокумент``` - тип ДокументСсылка, ссылка на документ, откуда происходит печать.
```СписокЧеков``` - тип Массив, содержит массив структур, это чеки, которые будут напечатаны, если список чеков получать в функции ```ОбработатьЧекПоСвоему```, то там всегда будет находиться только один основной чек, разбиение происходит только в самом конце перед пробитием. Какие именно реквизиты должен содержать чек можно посмотреть, вызвав ```ОсновнаяОбработки.мМодульККТОбщий.ПараметрыОперацииФискализацииЧека()```
```ПараметрыОбработки``` - тип Структура, содержит параметры обработки, как они заданы пользователем через форму настройки.
```СуммаБезНал``` - тип Число, сумма безналичной оплаты в чеке, _устарело_
```СуммаНал``` - тип число, сумма наличной оплаты в чеке, _устарело_
```ДополнительнаяСтруктураДокумента``` - тип Структура, см. ```ДанныеДляПечатиЧекаДокумента```
Выполняет типовой функционал заполнения и печати чека, с учетом переданной ссылки на документ, однако при этом, передав через ДополнительнаяСтруктураДокумента - дополнительные условия, мы можем управлять этим заполнением. Например, по умолчанию программа считает, что "**ПриходныйКассовыйОрдер**"  - это кассовый документ и содержит в себе табличную часть "**РасшифровкаПлатежа**", где указываются документы основания, однако если у вас он нетиповой, и не является кассовым, приходует товар, то мы можем передать вот так,

```bsl
Функция ОбработатьЧекПоСвоему(СсылкаНаДокумент, СписокЧеков, ПараметрыОбработки, СуммаБезНал = 0, СуммаНал = 0, ПропуститьПроверку = Ложь) Экспорт

    ПропуститьПроверку = Истина;

    ИмяДокумента = пДок.Метаданные().Имя;
    СтруктураДокумента = Неопределено;

    Если ИмяДокумента = "ПриходныйКассовыйОрдер" Тогда
        СтруктураДокумента = ДанныеДляПечатиЧекаДокумента();
        СтруктураДокумента.ЭтоКассовыйДокумент = Ложь;
        СтруктураДокумента.ТабличнаяЧасть = "Товары|Услуги";
    КонецЕсли;

    Возврат ОсновнаяОбработка.ОбработатьУниверсальныйДок(СсылкаНаДокумент, СписокЧеков, ПараметрыОбработки, СуммаБезНал, СуммаНал, СтруктураДокумента);

    Возврат "";
КонецФункции
```

```Функция ПроверитьПечатьИВернутьРезультат(СписокЧеков, ПараметрыОбработки)``` - проверяет необходимость открытия [Формы проверки печати](form_check_and_check_correction.md), и открывает ее. Удобно, если список чеков формируете самостоятельно, но пользователю хотите вывести для корректировки.

## Функции работы с оборудованием ##

```Процедура мМодульККТСобственная.ВыполнитьДополнительнуюКомандуОборудования``` - позволяет через доп обработчик вызвать дополнительную команду (это команды, которые предусмотрены только производителем определенного оборудования, например "Печать отчета по секциям") на подключенном фискальном регистраторе.
Параметры:
```ИмяФискальногоРегистратора``` - тип Строка, имя подключенного фискального регистратора, как вы его назвали через меню подключения дополнительного оборудования, если это основной фискальный регистратор, то оставляем строку пустой.
```ИмяДополнительнойКоманды``` - тип Строка, наименование дополнительной команды, как она прописана в описании драйвера, например ```PrintChooseReceiptCopy```

Пример,

```bsl
ОсновнаяОбработка.мМодульККТСобственная.ВыполнитьДополнительнуюКомандуОборудования("", "PrintChooseReceiptCopy");

```
